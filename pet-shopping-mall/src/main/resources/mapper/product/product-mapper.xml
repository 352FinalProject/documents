<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shop.app.product.repository.ProductRepository">
	
	<select id="findImageAttachmentsByProductId" resultMap="ProductImagesResultMap">
		select
		    p.product_id,
		    p.category_id,
		    p.product_name,
		    p.product_price,
		    p.product_name,
		    ia.image_original_filename,
		    ia.image_renamed_filename
		from 
		    product p
		left join 
		    image_attachment_mapping iam on p.product_id = iam.ref_id and iam.ref_table = 'product'
		left join
		    image_attachment ia ON iam.image_id = ia.image_id
		where 
	    	p.product_id = #{productId}
	</select>
	
 	<select id="searchProducts" resultMap="productSearchDto">
		select
		    p.product_id,
		    p.category_id,
		    p.create_date,
		    p.product_name,
		    p.product_price,
		    ia.image_renamed_filename,
		    decode(avg_star, NULL, 0.0, avg_star) as review_star_rate,
		    (select count(*) from review where product_id = p.product_id) reviewCnt
		from 
		    product p
		left join 
		    image_attachment_mapping iam on p.product_id = iam.ref_id and iam.ref_table = 'product'
		left join
		    image_attachment ia ON iam.image_id = ia.image_id
		left join
			(select product_id, round(avg(review_star_rate)) as avg_star from review group by product_id) r
			on p.product_id = r.product_id
		where 
	    	p.product_name like '%' || #{searchQuery} || '%'
	</select>
	
	<select id="alignProducts" resultMap="productSearchDto">
	    SELECT
	        p.product_id,
	        p.category_id,
	        p.create_date,
	        p.product_name,
	        p.product_price,
	        ia.image_renamed_filename,
	        DECODE(avg_star, NULL, 0.0, avg_star) AS review_star_rate,
	        (SELECT COUNT(*) FROM review WHERE product_id = p.product_id) reviewCnt
	    FROM
	        product p
	    LEFT JOIN
	        image_attachment_mapping iam ON p.product_id = iam.ref_id AND iam.ref_table = 'product'
	    LEFT JOIN
	        image_attachment ia ON iam.image_id = ia.image_id
	    LEFT JOIN
	        (SELECT product_id, ROUND(AVG(review_star_rate)) AS avg_star FROM review GROUP BY product_id) r
	        ON r.product_id = p.product_id
	    WHERE
	        p.category_id = #{categoryId}
	    <choose>
	        <when test="alignType == 'byPrice'">
	            ORDER BY
	                p.product_price
	                <choose>
	                    <when test="inOrder == 'asc'">ASC</when>
	                    <otherwise>DESC</otherwise>
	                </choose>
	        </when>
	        <when test="alignType == 'byNewDate'">
	            ORDER BY p.create_date DESC
	        </when>
	        <when test="alignType == 'byHighReviewStar'">
	            ORDER BY review_star_rate DESC
	        </when>
	        <when test="alignType == 'byReviewCnt'">
	            ORDER BY reviewCnt DESC
	        </when>
	        <otherwise>
	        	order By create_date desc
	        </otherwise>
	    </choose>
	</select>
	

	
	
	
	<resultMap type="ProductSearchDto" id="productSearchDto">
        <result property="productId" column="product_id"/>
        <result property="categoryId" column="category_id"/>
        <result property="createDate" column="create_date"/>
        <result property="productName" column="product_name"/>
        <result property="productPrice" column="product_price"/>
        <result property="reviewCnt" column="reviewCnt"/>
        <result property="imageRenamedFileName" column="image_renamed_filename"/>
        <result property="reviewStarRate" column="review_star_rate"/>
    </resultMap>

    <resultMap type="Product" id="productResultMap">
        <id property="productId" column="product_id"/>
        <result property="categoryId" column="category_id"/>
        <result property="productName" column="product_name"/>
        <result property="productPrice" column="product_price"/>
        <result property="imageId" column="image_id"/>
        <result property="createDate" column="create_date"/>
        <result property="expireDate" column="expire_date"/>
        <result property="likeCnt" column="like_cnt"/>
        <result property="viewCnt" column="view_cnt"/>
    </resultMap>
    
<resultMap type="ProductImages" id="ProductImagesResultMap">
        <id property="productId" column="product_id"/>
        <result property="categoryId" column="category_id"/>
        <result property="productName" column="product_name"/>
        <result property="productPrice" column="product_price"/>
        <result property="imageId" column="image_id"/>
        <result property="createDate" column="create_date"/>
        <result property="expireDate" column="expire_date"/>
        <result property="likeCnt" column="like_cnt"/>
        <result property="viewCnt" column="view_cnt"/>

    <!-- image_attachment 테이블의 내용을 imageAttachment 객체에 매핑 -->
    <collection property="attachments" ofType="imageAttachment">
        <result property="imageId" column="image_id"/>
        <result property="imageType" column="image_type"/>
        <result property="imageCategory" column="image_category"/>
        <result property="imageOriginalFilename" column="image_original_filename"/>
        <result property="imageRenamedFilename" column="image_renamed_filename"/>
        <result property="imageFileSize" column="image_file_size"/>
        <result property="imageCreatedAt" column="image_created_at"/>
    </collection>
</resultMap>


</mapper>